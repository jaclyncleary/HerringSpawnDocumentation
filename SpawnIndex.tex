%%%%% TODO %%%%%

% 5. Make an inset in Figure 1 showing the NE Pacific Ocean (PNW)
% 6. Sort out Length and Width metrics here, and in the code

%%%%% Preamble %%%%%

% Set document style and font size
\documentclass[12pt]{article}

% Style file for DFO Technical Reports
\usepackage{techreport}

% New definitions: Title, year, report number, authors
% Put words in math mode to prevent case changes (e.g., species name)
\newcommand{\trTitle}{Calculating the spawn index for Pacific herring ($Clupea$ $pallasii$) in British Columbia, Canada}
\newcommand{\trYear}{2017}
\newcommand{\trReportNum}{XXXX}
\newcommand{\trAuthFootA}{\footnote{E-mail: \texttt{Matthew.Grinnell@dfo-mpo.gc.ca} $|$ telephone: (250)~756.7055}}
\newcommand{\trAuthsLong}{Matthew H.~Grinnell,\trAuthFootA{} and others...}  % JC, MT, ...
\newcommand{\trAuthsBack}{Grinnell, M.\,H., et al...}

% New definition: Address
\newcommand{\trAddy}{Fisheries and Oceans Canada\\Science Branch, Pacific Region\\Pacific Biological Station\\3190 Hammond Bay Road\\Nanaimo, BC \enskip V9T 6N7}

% New definition: Citation
\newcommand{\trReference}{
\begin{hangparas}{1em}{1}
\trAuthsBack{} \trYear{}. \trTitle{}. Can. Tech. Rep. Fish. Aquat. Sci. \trReportNum{}: \pageref{TRlastRoman}{}\,+\,\pageref{LastPage}{}\,p.
\end{hangparas}}

% Abstract
\newcommand{\trAbstract}{
This report documents the calculations used to convert spawn survey observations (e.g., number of egg layers, extent, substrate) to the spawn index for Pacific herring ($Clupea$ $pallasii$) in British Columbia (BC), Canada.
There are three types of spawn survey observations: surface observations, underwater observations of spawn on Macrocystis, and underwater observations of spawn on understory.
First, we calculate the spawn index for each of these three survey types separately.
Then, we combine the three indices to determine the total spawn index.
Finally, we aggregate the total spawn index by year and stock assessment region, which is the temporal and spatial scale for Pacific herring science advice and fishery management in BC.
For example, the spawn index is one component of Pacific herring stock assessments in BC.
Note that the `spawn index' is not scaled by the spawn survey scaling parameter, $q$ and therefore is not an estimate of spawning stock biomass.}

% Resume (i.e., French abstract)
\newcommand{\trResume}{
[Et en français...]
}

% Set document options
%\linenumbers  % For drafts
%\onehalfspacing  % For drafts

% Let it begin
\begin{document}

% Sections in capitals
\renewcommand\listfigurename{LIST OF FIGURES}
\renewcommand\listtablename{LIST OF TABLES}

% Footnote symbols in front matter
\renewcommand*{\thefootnote}{\fnsymbol{footnote}}

%%%% Front matter %%%%%

% Format the first few pages
\input{Document/CoverPage.tex}  % Cover page
\input{Document/TechReportPage.tex}  % Tech report page
\input{Document/InsideCoverPage.tex}  % Inside cover page
\input{Document/ColophonPage.tex}  % Colophon page
\pdfbookmark[1]{\contentsname}{toc}  % Add TOC to pdf bookmarks (clickable)
\tableofcontents\clearpage  % Table of contents page
\listoffigures \listoftables \clearpage  % Lists of figures and tables (optional)
\input{Document/AbstractPage.tex}  % Abstact and resume page

% Settings for the main document
\pagenumbering{arabic}  % Regular page numbers
%\thispagestyle{empty}  % No page number on first page
\renewcommand*{\thefootnote}{\arabic{footnote}}  % Back to numeric footnotes
\setcounter{footnote}{0}  % And start at 1

% Settings for drafts
\renewcommand{\headrulewidth}{1pt}  % Header line
\pagestyle{fancy}\fancyhead[c]{Draft: Do not cite or circulate}  % Header text

%%%%% Main document %%%%%

\section{INTRODUCTION}

This report documents the calculations used to convert spawn survey observations (e.g., number of egg layers, extent, substrate) to the spawn index for Pacific herring ($Clupea$ $pallasii$) in British Columbia (BC), Canada.
The process and calculations described in this report have been documented elsewhere, in either published or informal, internal documents.
Our goal is to collect and simplify the details necessary to understand the process for calculating the spawn index.
The spawn index calculations have been revised over the years; we restrict this report to describing the current methods.%
\footnote{Include (or mention) `old' ways of calculating egg density? 
For example, there are two ways for \autoref{eqEggDensUnderV}.
I suspect this isn't necessary, and would open up a lot of unnecessary/irrelevant history.}
The spawn index is an important component of Pacific herring stock assessments in BC.
Note that the `spawn index' is not scaled by the spawn survey scaling parameter, $q$ \citeyearpar[CSAS][]{CSAS2015b} and therefore is not an estimate of spawning stock biomass.

The motivation to document the spawn index calculations came when we translated the process from a \textbf{Microsoft Access} database to an \textbf{R} \citeyearpar[RCT][]{R-3.3.2} script.
We updated from a database to an \textbf{R} script for several reasons.
First, the database has been used for various purposes over several decades, and has incidental calculations that make it overly complex.
Second, the database is difficult to troubleshoot, and to differentiate between input (i.e., data) and derived values.
Third, the \textbf{R} script is open and transparent; users are welcome to view and download the script and example data (\autoref{secDown}).
Fourth, we consider it good practice to separate data from analyses.
Finally, a separate \textbf{R} script will allow us to generate dynamic documents in the spirit of reproducible research using \textbf{knitr} \citep{Xie2015}.

Spawn surveys collect data used to calculate the spawn index.
There are three types of spawn survey observations: surface observations, underwater observations of spawn on Macrocystis, and underwater observations of spawn on understory.
Note that understory observations have two components: spawn on the bottom, and spawn on vegetation (i.e., algae).
Surface spawn surveys have the coarsest spatial resolution and greatest spatial extent of the three survey types (Ref?).
Surface spawn surveys were the only survey type prior to 1988, and they are still used extensively for minor spawns because they are adequate for narrow spawns in shallow water (Ref?).
Macrocystis and understory spawn surveys are conducted using SCUBA gear.
Underwater SCUBA surveys have been used for all major spawns since 1988, and are thought to be more accurate than surface spawn surveys (Ref?).
Herring spawn surveys began in 1928, but are considered incomplete prior to 1937 because many potential areas were not surveyed (Ref?).

Herring spawn survey observations have a nested hierarchical structure: quadrats are nested within transects, transects are nested within spawns, and spawns are nested within locations.
For stock assessment purposes, locations are nested within sections, sections are nested within statistical areas, and statistical areas are nested within five major and two minor stock assessment regions (SARs) in BC.
The major SARs are Haida Gwaii, Prince Rupert District, Central Coast, Strait of Georgia, and West Coast Vancouver Island; the minor SARs are Area 27, and Area 2 West (\autoref{figBC}).
Another level of data structure is `beds', which are habitat features as opposed to distinct spatial areas.
Bed widths are used to calculate the spawn index for surface surveys.

\begin{figure}
\centering
\includegraphics[width=\linewidth]{Figures/BC.pdf}
\caption[Boundaries for Pacific herring stock assessment regions (SARs)]
{Boundaries for British Columbia Pacific herring stock assessment regions (SARs): there are five major SARs (Haida Gwaii, HG; Prince Rupert District, PRD; Central Coast, CC; Strait of Georgia, SoG; and West Coast Vancouver Island, WCVI), and two minor SARs (Area 27, A27; and Area 2 West, A2W).}
\label{figBC}
\end{figure}

We have divided this report into sections.
First, we describe the data pre-processing that occurs when raw survey observations are imported into the database (\autoref{secData}).
Then, we quantify Pacific herring fecundity (\autoref{secFecund}), which is critical to calculating the spawn index.
Then, we describe the calculations for each of the three aforementioned spawn survey types: surface (\autoref{secSurf}), Macrocystis (\autoref{secMacro}), and understory (\autoref{secUnder}).
Within each section, each level of spatial aggregation (e.g., calculations at the quadrat, or transect level) is in a separate subsection.
Next, we combine the three spawn indices to get the total spawn index (\autoref{secTotal}).
Finally, we describe how users can download and run the \textbf{R} script to calculate the spawn index (\autoref{secDown}).
Note that we have avoided subscript notation in the following equations to correspond with the \textbf{R} script which does not use subscripts (e.g., no `for' loops or indexing).%make this report more accessible, and to
\footnote{We could add subscript notation if required.}

\section{DATA PRE-PROCESSING}\label{secData}

TODO:
\begin{itemize}
\item Describe the database calculations/pre-processing (if any?) that occurs when raw survey data are entered, which create the tables imported by \texttt{SpawnIndex.R} (e.g., \texttt{tSSAllspawn}, \texttt{tSSMacTrans}).
\item Reproduce these in \textbf{R} to fully understand them, instead of relying on the database?
\end{itemize}

\section{FECUNDITY}\label{secFecund}

Female Pacific herring produce an average of 200 eggs per gram, g of total body weight \citep{Hay1985}.
We assume that females account for 50\% of spawners, and we use the following fecundity conversion factor for eggs to tonnes, t of spawners
\begin{equation}
\frac {1 \cdot 10^{8}~\text{eggs}} {\text{t}} = \frac{200~\text{eggs}} {\text{g}} \times 0.5 \times \frac{1 \cdot 10^{6}~\text{g}} {\text{t}} \enspace .
\label{eqFecundityConv}
\end{equation}
Note that our unit of measurement for eggs is thousands (i.e., $\text{eggs} \cdot 10^{3}$) in the \textbf{R} script, and correspondingly in this report.
Therefore, we divide $\text{eggs} \cdot 10^{3}$ by $1 \cdot 10^{5}$ to determine spawning biomass in tonnes.

\section{SURFACE SPAWN}\label{secSurf}

Surface spawn surveys collect data along transects, and we calculate spawn metrics at the transect, and spawn/bed level.

\subsection{TRANSECT LEVEL CALCULATIONS}

For each bottom type, egg layers is
\begin{equation}
EggLyrs = Layers \times Proportion
\label{eqEggLayersSurf}
\end{equation}
where $Layers$ is the number of egg layers on a given bottom type, and $Proportion$ is the proportion of the transect covered by the bottom type.
At the transect level, the sum of $EggLyrs$ is $EggLyrsTotT$.
That is to say, $EggLyrsTotT$ is the sum of $EggLyrs$ for all the bottom types within a given transect.
For the time period when spawn `intensity' categories were recorded instead of estimating the number of egg layers, intensity is converted to $EggLyrsTotT$ (\autoref{tabIntensity}).
Surface egg density in thousands is \citep{SchweigertEtal1997}%
\footnote{Notwithstanding the units provided in \cite{SchweigertEtal1997}, surface egg density is in thousands ($\text{eggs} \cdot 10^{3} \cdot \text{m}^{-2}$; J.~Schweigert, personal communication, 24 February 2017).}
\begin{equation}
EggDensT = EggLyrsTotT \times 212.218 + 14.698
\label{eqEggDensSurf}
\end{equation}
where $EggDensT$ is in $\text{Eggs} \cdot 10^{3} \cdot \text{m}^{-2}$. 

\begin{table}
\centering
\caption[Spawn intensity categories and associated egg layers for Pacific herring surface spawn surveys]
{Spawn intensity categories and associated egg layers for Pacific herring surface spawn surveys for the periods 1928--1950, and 1951--1978 (Ref?).
Note that intensity was sometimes recorded after being officially discontinued in 1978.}
\begin{tabular}{ccr}
\toprule
\multicolumn{2}{c}{Intensity category} & \\
1928--1950 & 1951--1978 & Egg layers\\
\midrule
0 & 0 & 0.0000 \\
1 & 1 & 0.5529 \\
 & 2 & 0.9444 \\
2 & 3 & 1.3360 \\
 & 4 & 2.1496 \\
3 & 5 & 2.9633 \\
 & 6 & 4.1318 \\
4 & 7 & 5.3002 \\
 & 8 & 6.5647 \\
5 & 9 & 7.8291 \\
\bottomrule
\end{tabular}
\label{tabIntensity}
\end{table}

\subsection{SPAWN/BED LEVEL CALCULATIONS}

At the spawn/bed level, the mean of $EggDensT$ is $EggDensMeanS$.
Two other metrics are required at the spawn/bed level: the spawn/bed length $Length$ and width $WidthS$, both in metres.
We set $WidthS$ to the first non-missing value of bed width, section width, region width, or observed width (in that order).
The surface spawn index is
\begin{equation}
SurfSI = \frac{EggDensMeanS \times Length \times WidthS} {1 \cdot 10^{5}}
\label{eqBiomassSurf}
\end{equation}
where $SurfSI$ is in tonnes, based on the fecundity conversion factor (\autoref{eqFecundityConv}).

\subsection{MANUAL CORRECTIONS}\label{subsecUpdate}

There are several survey records with missing or inaccurate egg layer information in the surface spawn database.
We update $EggLyrsTotT$ for these records... why/how  (J.~Schweigert, personal communication, 21 February 2017)?
For example, in most/some cases we update $EggLyrsTotT$ based on spawn intensity categories (\autoref{tabIntensity}).
This section needs work.
%Missing or inaccurate egg layer information.
%One update changes the intensity from 0 to 1 to reflect...?
We update the following records:
\begin{enumerate}
\item Update $EggLyrsTotT$ to 2.1496 for the 15 records in the year 1979, statistical area 2, and with intensity 4; \label{up1979}
\item Update $EggLyrsTotT$ to 0.5529 for the 1 record in the year 1962, statistical area 14, and with intensity 0; \label{up1962}
\item Update $EggLyrsTotT$ to 0.5529 for the 4 records in the year 1981, statistical area 24, and with $EggLyrsTotT = 0$; \label{up1981}
\item Update $EggLyrsTotT$ to 1.3360 for the 7 records in the year 1982, statistical area 23, and with intensity 3; \label{up1982a}
\item Update $EggLyrsTotT$ to 2.33\footnote{Where does this come from?} for the 41 records in the year 1984, statistical area 24, and with intensity 0; and \label{up1984}
\item Update $EggLyrsTotT$ to 2.98\footnote{Where does this come from?} for the 14 records in the year 1982, statistical area 27, and with $EggLyrsTotT = 0$. \label{up1982b}
\end{enumerate}

\section{MACROCYSTIS SPAWN}\label{secMacro}

Macrocystis spawn surveys collect data for individual plants, and we calculate spawn metrics at the transect, and spawn levels.
Macrocystis spawn is only calculated for `mature' plants, which are defined as?%
\footnote{What is a mature plant?
Are immature plants covered in the `understory' spawn calculations?}

\subsection{TRANSECT LEVEL CALCULATIONS}

Several metrics are collected at the transect level: transect length $LengthT$, transect width $WidthT$, and Macrocystis length $LengthMacroT$, all in metres, as well as transect area $AreaT$, in square metres.
`Macrocystis length' is the distance that the Macrocystis extends perpendicular to the shore (?).
Note that we set $LengthMacroT$ to the transect length $Length$ if $LengthMacroT$ is inadvertently not recorded.
In addition, we calculate metrics for mature Macrocystis plants: mean height $HeightMeanT$ in metres, mean egg layers $LayersMeanT$, total number of fronds $FrondsTotT$, and total number of plants $PlantsTotT$.

\subsection{SPAWN LEVEL CALCULATIONS}

At the spawn level, the mean of $LengthMacroT$ is $LengthMacroMeanS$, the mean of $LengthT$ is $LengthMeanS$, and the sum of $AreaT$ is $AreaTotS$, all in metres.
In addition, the sum of $PlantsTotT$ is $PlantsTotS$, the sum of $FrondsTotT$ is $FrontsTotS$, the mean of $HeightMeanT$ is $HeightMeanS$, and the mean of $LayersMeanT$ is $LayersMeanS$. 
The number of fronds per plant is
\begin{equation}
FrondsPerPlantS = \frac{FrondsTotS} {PlantsTotS} \, .
\label{eqFrondsPerPlant}
\end{equation}
The number of eggs per plant in thousands is \citep{HaegeleSchweigert1990}
\begin{multline}
EggsPerPlantS = 0.073 \times LayersMeanS^{0.673} \times \\ 
HeightMeanS^{0.932} \times FrondsPerPlantS^{0.703} \times 1 \cdot 10^{3}
\label{eqEggsPerPlantMacro}
\end{multline}
where $EggsPerPlantS$ is in $\text{Eggs} \cdot 10^{3} \cdot \text{plant}^{-1}$. 
Macrocystis egg density in thousands is
\begin{equation}
EggDensS = \frac{EggsPerPlantS \times PlantsTotS} {AreaTotS}
\label{eqEggDensityMacro}
\end{equation}
where $EggDenS$ is in $\text{Eggs} \cdot 10^{3} \cdot \text{m}^{-2}$.
The Macrocystis spawn index is
\begin{equation}
MacroSI = \frac{EggDensS \times LengthMacroMeanS \times LengthMeanS} {1 \cdot 10^{5}}
\label{eqBiomassMacro}
\end{equation}
where $MacroSI$ is in tonnes, based on the fecundity conversion factor (\autoref{eqFecundityConv}).

\section{UNDERSTORY SPAWN}\label{secUnder}

Understory spawn surveys collect data in quadrats, and we calculate spawn metrics at the quadrat, transect, and spawn levels.
We calculate two separate estimates of egg density at the quadrat level: spawn on the bottom, and spawn on vegetation (i.e., algae).

\subsection{QUADRAT LEVEL CALCULATIONS}

Bottom egg density in thousands is \citep{HaegeleEtal1979}
\begin{equation}
EggsDBot = 340 \times BotLayers \times BotProp
\label{eqEggDensUnderB}
\end{equation}
where $BotLayers$ is the number of egg layers on the bottom, $BotProp$ is the proportion of the bottom covered in spawn, and $EggsDBot$ is in $\text{Eggs} \cdot 10^{3} \cdot \text{m}^{-2}$.
Vegetation egg density in thousands is \citep{Schweigert2005}
\begin{multline}
EggsDVeg = 600.567 \times VegLayers^{0.6355} \times VegProp^{1.413} \times V \times 1.0512
\label{eqEggDensUnderV}
\end{multline}
where $VegLayers$ is the number of egg layers on a given vegetation type, $VegProp$ is the proportion of the bottom covered by the vegetation, $V$ is the vegetation coefficient (\autoref{tabVegTypes}), and $EggsDVeg$ is in $\text{Eggs} \cdot 10^{3} \cdot \text{m}^{-2}$.
%Note that \autoref{eqEggDensUnderV} replaces an earlier equation for vegetation egg density which is no longer in use:
%\begin{multline}
%EggsDVeg = 1033.6694 \times VegLayers^{0.7137} \times VegProp^{1.5076} \times V \times 0.502 \enspace .
%\label{eqOldEggDensUnderV}
%\end{multline}
The total linear weighted understory egg density in thousands is%
\footnote{Explain why we calculate weighted egg density, $EggDensWtQ$.
Is it because transects are different lengths (which we call widths)?}
\begin{equation}
EggDensWtQ = \left( EggsDBot + EggsDVeg \right) \times Width
\label{eqEggDensWtUnder}
\end{equation}
where $Width$ is the transect width in metres, and $EggDensWtQ$ is in $\text{Eggs} \cdot 10^{3} \cdot \text{m}^{-1}$.
Note that we expand $Width$ in certain years to account for footrope expansion when wet, when applicable.%
\footnote{We don't do this, so can we remove if from here, and the \textbf{R} script?}

\begin{table}
\centering
\caption[Vegetation (i.e., algae) types and coefficients for Pacific herring understory spawn surveys]
{Vegetation (i.e., algae) types and coefficients, $V$ for Pacific herring understory spawn surveys \citep{Schweigert2005}.}
\begin{tabular}{lr}
\toprule
Vegetation type & Coefficient, $V$\\
\midrule
Grasses & 0.9715 \\
Grunge & 1.0000 \\
Kelp, flat & 0.9119 \\
Kelp, standing & 1.1766 \\
Leafy algae & 0.6553 \\
Rockweed & 0.7793 \\
Sargassum & 1.1766 \\
Stringy algae & 1.0000 \\
\bottomrule
\end{tabular}
\label{tabVegTypes}
\end{table}

\subsection{TRANSECT LEVEL CALCULATIONS}

At the transect level, the mean $EggDensWtQ$ is $EggDensWtMeanT$.

\subsection{SPAWN LEVEL CALCULATIONS}

At the spawn level, the sum of transect widths $Width$ is $WidthTotS$, the mean of $Width$ is $WidthMeanS$, and the vegetation length is $VegLengthS$, all in metres.
`Vegetation length' is the distance that the vegetation extends perpendicular to the shore (?).
Note that we set $VegLength$ to the transect length $Length$ if $VegLength$ is inadvertently not recorded.
The sum of $EggDensWtMeanT$ is $EggDensWtTotS$.
Understory egg density is 
\begin{equation}
EggDensWtS = \frac{EggDensWtTotS} {WidthTotS}
\label{eqEggDensityUnder}
\end{equation}
where $EggDensWtS$ is in $\text{Eggs} \cdot 10^{3} \cdot \text{m}^{-2}$.
The understory spawn index is
\begin{equation}
UnderSI = \frac{EggDensWtS \times VegLengthS \times WidthMeanS} {1 \cdot 10^{5}}
\label{eqBiomassUnder}
\end{equation}
where $UnderSI$ is in tonnes, based on the fecundity conversion factor (\autoref{eqFecundityConv}).

\section{TOTAL SPAWN}\label{secTotal}

The total spawn index for each spawn is
\begin{equation}
TotalSI = SurfSI + MacroSI + UnderSI
\label{eqTotalSI}
\end{equation}
where $TotalSI$ is in tonnes.
Although we track the date and location (i.e., eastings, northings) for each spawn event, we aggregate the total spawn index by year and SAR to align with the temporal and spatial scale for Pacific herring science advice and fishery management in BC \citeyearpar[CSAS][]{CSAS2015b}.
As previously mentioned, the `spawn index' is not scaled by the spawn survey scaling parameter, $q$ \citeyearpar[CSAS][]{CSAS2015b} and therefore is not an estimate of spawning stock biomass.
Furthermore, Pacific herring spawn indices are derived values (i.e., from calculations, which rely on assumptions), as opposed to observed data.

\section{DOWNLOAD}\label{secDown}

As previously mentioned, the \textbf{R} script to calculate the Pacific herring spawn index, \texttt{SpawnIndex.R} is publicly accessible on \textbf{GitHub} (URL?).
Users can also download an example database of herring spawn survey observations to use with the script.
Instructions for running \texttt{SpawnIndex.R} are on the \textbf{GitHub} website.
Essentially, the \textbf{R} script imports data from the Pacific herring spawn survey database (Ref?), and follows the calculations described in this report.

This report is meant to accompany the \textbf{R} script, which has complete details regarding how we implement the spawn index calculations.
Sections in this report correspond somewhat to functions in the \textbf{R} script.
For example, \autoref{secSurf}, `Surface spawn' follows the \textbf{R} function \texttt{CalcSurfaceSpawn}.
In addition, variable names in this report correspond to variable names in the script; 
Finally, we have commented each line in the \textbf{R} script to promote accessibility and transparency.

\section{ACKNOWLEDGEMENTS}

Keep in mind those we may want to thank:
\begin{itemize}
\item Ashleen Benson for translating the \textbf{Microsoft Access} database to an \textbf{R} script, which we referenced when writing \texttt{SpawnIndex.R}
\item Jake Schweigert for background and justification of the manual corrections (\autoref{subsecUpdate})
\end{itemize}

% References
\bibliographystyle{Document/CJFAS}
\addcontentsline{toc}{section}{\refname}\bibliography{C:/Grinnell/References/Grinnell}

% The end
\end{document}
